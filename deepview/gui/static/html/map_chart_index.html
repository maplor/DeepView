<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css"> -->
    <link rel="stylesheet" href="../css/leaflet.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .leaflet-control-attribution {
            display: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <!-- <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script> -->
    <script src="../js/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([31.505, 139.09], 2);
        // let map_data = [
        //     { index: 0, latitude: 38.67688, longitude: 139.408737, timestamp: '2018-09-10T20:20:00.000Z' },
        //     { index: 1, latitude: 38.679394, longitude: 139.411133, timestamp: '2018-09-10T20:21:00.000Z' },
        //     { index: 2, latitude: 38.681908, longitude: 139.413529, timestamp: '2018-09-10T20:22:00.000Z' },
        // ];

        let map_data = [
            { index: 0, latitude: 38.67688, longitude: 139.408737, timestamp: '2018-09-10T20:20:00.000Z' },
            { index: 1, latitude: 38.679394, longitude: 139.411133, timestamp: '2018-09-10T20:21:00.000Z' },
            { index: 2, latitude: 38.681908, longitude: 139.413529, timestamp: '2018-09-10T20:22:00.000Z' },
        ];

        // 定义两个不同的瓦片图层
        var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        var lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        // }).addTo(map);

        lightLayer.addTo(map);

        // var markers = []; // 用于存储所有标记的数组
        var markers = L.featureGroup().addTo(map); // 用于存储所有标记的FeatureGroup
        var polyline = null; // 用于存储折线
        let latlngs = []; // 折线经纬度
        var highlightedMarker = null; // 用于存储当前高亮的标记
        var highlightedTwoMarker = null;

        function initialize() {
            // 清空所有标记
            markers.clearLayers();
            if (polyline) {
                map.removeLayer(polyline);
            }
            latlngs = [];
            map_data.forEach(function (item) {
                addMarker(item.index, item.latitude, item.longitude);
                latlngs.push([item.latitude, item.longitude]);
            });

            // 添加折线
            polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);

            map.fitBounds(markers.getBounds());
        }

        function addMarker(id, lat, lon) {
            var marker = L.circleMarker([lat, lon], {
                radius: 3, // 半径为5像素
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5
            }).addTo(map);

            marker.on('click', function () {
                console.log('Marker ID:', id);
                console.log('Latitude:', lat);
                console.log('Longitude:', lon);
                LineChartHighlightDotByIndex(id);
            });

            // markers[id] = marker; // 将标记添加到字典中
            marker._id = id;
            markers.addLayer(marker); // 将标记添加到FeatureGroup中
        }

        function addNewPoint(id, lat, lon) {
            addMarker(id, lat, lon);

            // 确保id是唯一的
            if (map_data.some(item => item.index === id)) {
                console.warn(`索引为 ${id} 的点已存在。`);
                return;
            }
            // 创建新点
            var newPoint = { index: id, latitude: lat, longitude: lon, timestamp: new Date().toISOString() };
            // 插入新点
            map_data.push(newPoint);

            // 按 index 排序
            map_data.sort((a, b) => a.index - b.index);

            // if (polyline) {
            //     map.removeLayer(polyline);
            // }

            // 更新折线
            var latlngs = map_data.map(item => [item.latitude, item.longitude]);
            polyline.setLatLngs(latlngs);
            // polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);
        }

        function highlightMarker(id, lat, lon) {
            if (highlightedMarker) {
                // 取消之前高亮的标记
                highlightedMarker.setStyle({
                    color: 'red',
                    fillColor: '#f03',
                    radius: 3
                });
            }
            resetHighlightedMarkers()

            // 查找具有指定ID的标记
            var marker = null;
            markers.eachLayer(function (layer) {
                if (layer._id === id) {
                    marker = layer;
                }
            });

            if (marker) {
                // 如果标记已存在，则直接高亮
                // marker.setStyle({
                //     color: 'blue',
                //     fillColor: '#03f',
                //     radius: 10 // 增加半径以更明显地高亮
                // }).bindTooltip("Highlighted Marker").openTooltip();
                marker.setStyle({
                    color: 'blue',
                    fillColor: '#03f',
                    radius: 10 // 增加半径以更明显地高亮
                });
                highlightedMarker = marker;
                map.fitBounds(markers.getBounds());
                map.setView(marker.getLatLng());
                // map.setView(marker.getLatLng(), 5); // 设置地图中心和缩放级别
            } else {
                // 如果标记不存在则添加并高亮
                // addMarker(id, lat, lon);
                addNewPoint(id, lat, lon)
                // 再次查找新添加的标记
                markers.eachLayer(function (layer) {
                    if (layer._id === id) {
                        marker = layer;
                    }
                });
                if (marker) {
                    marker.setStyle({
                        color: 'blue',
                        fillColor: '#03f',
                        radius: 10
                    });
                    highlightedMarker = marker;
                    map.fitBounds(markers.getBounds());
                    map.setView(marker.getLatLng());
                }
            }
        }
        function resetHighlightedMarkers() {
            if (highlightedTwoMarker) {
                // 取消之前高亮的标记
                highlightedTwoMarker.forEach(function (marker) {
                    marker.setStyle({
                        color: 'red',
                        fillColor: '#f03',
                        radius: 3
                    }).unbindTooltip();
                });
            }
        }

        function highlightTwoMarkers(id1, lat1, lon1, id2, lat2, lon2) {
            resetHighlightedMarkers()
            if (highlightedMarker) {
                // 取消之前高亮的标记
                highlightedMarker.setStyle({
                    color: 'red',
                    fillColor: '#f03',
                    radius: 3
                });
            }

            // 查找具有指定ID的标记
            var marker1 = null;
            var marker2 = null;
            markers.eachLayer(function (layer) {
                if (layer._id === id1) {
                    marker1 = layer;
                }
                if (layer._id === id2) {
                    marker2 = layer;
                }
            });

            if (marker1) {
                marker1.setStyle({
                    color: 'blue',
                    fillColor: '#03f',
                    radius: 10 // 增加半径以更明显地高亮
                }).bindTooltip("start").openTooltip();
            } else {
                addNewPoint(id1, lat1, lon1);
                markers.eachLayer(function (layer) {
                    if (layer._id === id1) {
                        marker1 = layer;
                    }
                });
                if (marker1) {
                    marker1.setStyle({
                        color: 'blue',
                        fillColor: '#03f',
                        radius: 10
                    }).bindTooltip("start").openTooltip();
                }
            }

            if (marker2) {
                marker2.setStyle({
                    color: 'blue',
                    fillColor: '#03f',
                    radius: 10 // 增加半径以更明显地高亮
                }).bindTooltip("end").openTooltip();
            } else {
                addNewPoint(id2, lat2, lon2);
                markers.eachLayer(function (layer) {
                    if (layer._id === id2) {
                        marker2 = layer;
                    }
                });
                if (marker2) {
                    marker2.setStyle({
                        color: 'blue',
                        fillColor: '#03f',
                        radius: 10
                    }).bindTooltip("end").openTooltip();
                }
            }

            highlightedTwoMarker = [marker1, marker2];
            map.fitBounds(markers.getBounds());
        }


        // 点击折线图高亮对应的标记
        function highlightByIndexAndLatLng(index, lat, lon) {
            highlightMarker(index, lat, lon);
        }

        function LineChartHighlightDotByIndex(index) {

            if (highlightedMarker) {
                // 取消之前高亮的标记
                highlightedMarker.setStyle({
                    color: 'red',
                    fillColor: '#f03',
                    radius: 3
                });
            }
            resetHighlightedMarkers()

            // 查找具有指定ID的标记
            var marker = null;
            markers.eachLayer(function (layer) {
                if (layer._id === index) {
                    marker = layer;
                }
            });

            if (marker) {
                // 如果标记已存在，则直接高亮
                marker.setStyle({
                    color: 'blue',
                    fillColor: '#03f',
                    radius: 10 // 增加半径以更明显地高亮
                });
                highlightedMarker = marker;
            }

            console.log("index:", index);
            backendmap.handleHighlightLineDotByIndex(index)
        }

        function displayMapData(data) {
            console.log("Received data type:", typeof data);
            map_data = JSON.parse(data);
            latlngs = [];
            initialize()
        }

        function updateMapTheme(theme) {
            if (theme === 'dark') {
                // 切换到深色主题
                map.removeLayer(lightLayer);
                map.addLayer(darkLayer);
            } else {
                // 切换到浅色图层
                map.removeLayer(darkLayer);
                map.addLayer(lightLayer);

            }
        }


        new QWebChannel(qt.webChannelTransport, function (channel) {
            // console.log(channel)
            // console.log(channel.objects)
            // console.log(channel.objects.backendmap)
            window.backendmap = channel.objects.backendmap;
        });

    </script>
</body>

</html>