<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>Leaflet Map</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .leaflet-control-attribution {
            display: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script>
        var map = L.map('map').setView([31.505, 139.09], 2);
        let map_data = [
            { index: 0, latitude: 38.67688, longitude: 139.408737, timestamp: '2018-09-10T20:20:00.000Z' },
            { index: 1, latitude: 38.679394, longitude: 139.411133, timestamp: '2018-09-10T20:21:00.000Z' },
            { index: 2, latitude: 38.681908, longitude: 139.413529, timestamp: '2018-09-10T20:22:00.000Z' },
        ];

        // 定义两个不同的瓦片图层
        var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });

        var lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        // }).addTo(map);

        darkLayer.addTo(map);

        // var markers = []; // 用于存储所有标记的数组
        var markers = L.featureGroup().addTo(map); // 用于存储所有标记的FeatureGroup
        var highlightedMarker = null; // 用于存储当前高亮的标记

        function initialize() {
            map_data.forEach(function (item) {
                addMarker(item.index, item.latitude, item.longitude);
            });
            map.fitBounds(markers.getBounds());
        }

        function addMarker(id, lat, lon) {
            var marker = L.circleMarker([lat, lon], {
                radius: 3, // 半径为5像素
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5
            }).addTo(map);

            marker.on('click', function () {
                console.log('Marker ID:', id);
                console.log('Latitude:', lat);
                console.log('Longitude:', lon);
                LineChartHighlightDotByIndex(id);
            });

            // markers[id] = marker; // 将标记添加到字典中
            markers.addLayer(marker); // 将标记添加到FeatureGroup中
        }

        function highlightMarker(id, lat, lon) {
            if (highlightedMarker) {
                // 取消之前高亮的标记
                highlightedMarker.setStyle({
                    color: 'red',
                    fillColor: '#f03',
                    radius: 3
                });
            }

            // if (markers[id]) {
            //     // 如果标记已存在，则直接高亮
            //     var marker = markers[id];
            //     marker.setStyle({
            //         color: 'blue',
            //         fillColor: '#03f',
            //         radius: 10 // 增加半径以更明显地高亮
            //     });
            //     highlightedMarker = marker;
            //     map.setView(marker.getLatLng(), 5); // 设置地图中心和缩放级别
            // } else {
            //     // 如果标记不存在则添加并高亮
            //     addMarker(id, lat, lon);
            //     highlightMarker(id, lat, lon);
            // }
            if (markers.getLayers()[id]) {
                // 如果标记已存在，则直接高亮
                var marker = markers.getLayers()[id];
                marker.setStyle({
                    color: 'blue',
                    fillColor: '#03f',
                    radius: 10 // 增加半径以更明显地高亮
                });
                highlightedMarker = marker;
                map.setView(marker.getLatLng(), 5); // 设置地图中心和缩放级别
            } else {
                // 如果标记不存在则添加并高亮
                addMarker(id, lat, lon);
                highlightMarker(id, lat, lon);
            }
        }

        // 点击折线图高亮对应的标记
        function highlightByIndexAndLatLng(index, lat, lon) {
            highlightMarker(index, lat, lon);
        }

        function LineChartHighlightDotByIndex(index) {
            console.log("index:", index);
            // backend_map.handleHighlightLineDotByIndex(index)
            // backendmap.LineChartHighlightDotByIndex(index)
            backendmap.handleHighlightLineDotByIndex(index)
        }

        function displayMapData(data) {
            console.log("Received data type:", typeof data);
            map_data = JSON.parse(data);
            initialize()
        }

        function updateMapTheme(theme) {
            if (theme === 'dark') {
                // 切换到深色主题
                map.removeLayer(lightLayer);
                map.addLayer(darkLayer);
            } else {
                // 切换到浅色图层
                map.removeLayer(darkLayer);
                map.addLayer(lightLayer);

            }
        }


        new QWebChannel(qt.webChannelTransport, function (channel) {
            // console.log(channel)
            // console.log(channel.objects)
            // console.log(channel.objects.backendmap)
            window.backendmap = channel.objects.backendmap;
            // window.backendmap.displayMapData.connect(displayMapData);
        });

    </script>
</body>

</html>